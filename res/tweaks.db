###!> tweak_name: GavinK88/d2gl-mxl-1.0
###!> tweak_version: any
sleep 1.5
github_author=GavinK88
github_repo=d2gl-mxl-1.0
releases_url="https://github.com/${github_author}/${github_repo}/releases"
github_version=$(zenity --entry --title="${github_author}/${github_repo}" --text="Upstream:\n${releases_url}\n\nEnter GitHub Release-Version (e.g. 1.0.5):" --entry-text="1.0.5") || exit 1
file_name="${github_author}-${github_repo}-${github_version}"
file_ext="zip"
download_url="${releases_url}/download/${github_version}/Release.${file_ext}"
mkdir -p "${HOME}/.d2launcher/tweaks/"
echo "// ${download_url}"

# Check version
if [ -z "$github_version" ]; then
    echo "Invalid GitHub Version"
    exit 1
fi

# Download if not exists
if [ ! -f "${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}" ]; then
    if curl -Lfs "${download_url}" >"${file_name}.${file_ext}"; then
        mv -f "${file_name}.${file_ext}" "${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}"
    else
        echo "Error downloading ${download_url}"
        exit 1
    fi
fi

# Unzip
if ! unzip -q -o "${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}" -d "${HOME}/.d2launcher/bin/diablo2"; then
    echo "Error unzip ${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}"
    exit 1
fi

# Finish
echo ''
echo '// You have to do these steps manually'
echo ' - Set property: d2_args="-3dfx"'
echo ' - Set property: mxl_update_exclude=("d2gl.mpq" "glide3x.dll")'
echo ' - Open D2GL Settings in Diablo II with: CTRL + o'
echo ''

###!> tweak_name: FunkyFr3sh/cnc-ddraw
###!> tweak_version: latest
github_author=FunkyFr3sh
github_repo=cnc-ddraw
github_version=latest
file_name="${github_author}-${github_repo}-${github_version}"
file_ext="zip"
releases_url="https://github.com/${github_author}/${github_repo}/releases"
download_url="${releases_url}/latest/download/cnc-ddraw.${file_ext}"
mkdir -p "${HOME}/.d2launcher/tweaks/"
echo "// ${download_url}"

# Download
if curl -Lfs "${download_url}" >"${file_name}.${file_ext}"; then
    mv -f "${file_name}.${file_ext}" "${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}"
else
    echo "Error downloading ${download_url}"
    exit 1
fi

# Unzip
if ! unzip -q -o "${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}" -d "${HOME}/.d2launcher/bin/diablo2"; then
    echo "Error unzip ${HOME}/.d2launcher/tweaks/${file_name}.${file_ext}"
    exit 1
fi

# Finish
echo ''
echo '// You have to do these steps manually'
echo ' - Set property: d2_args="-ddraw"'
echo ' - Set property: mxl_update_exclude=("ddraw.dll" "cnc-ddraw config.exe")'
echo ' - Goto Settings > Wine Settings > Library > Override/Add ddraw (set DLL load strategy to: native then built in)'
echo ' - Optimize prefered settings: Settings > Direct Draw Settings (optional)'
echo ''
